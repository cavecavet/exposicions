<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor de Fitxes - FotosCavet</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    /* Login Screen */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-box {
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      padding: 40px;
      width: 100%;
      max-width: 400px;
    }

    .login-box h1 {
      color: #333;
      margin-bottom: 30px;
      text-align: center;
      font-size: 28px;
    }

    .info-box {
      background: #e8f4f8;
      border-left: 4px solid #667eea;
      padding: 20px;
      margin-bottom: 25px;
      border-radius: 6px;
      color: #2c3e50;
      line-height: 1.6;
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #333;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-family: inherit;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .login-btn {
      width: 100%;
      padding: 14px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }

    .login-btn:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      border: 1px solid #f5c6cb;
      display: none;
      text-align: center;
      font-size: 14px;
    }

    .error-message.show {
      display: block;
    }

    /* Main App */
    .app-container {
      display: none;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .app-container.active {
      display: block;
    }

    .app-header {
      background: white;
      border-radius: 12px;
      padding: 20px 30px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .app-header h1 {
      color: #333;
      font-size: 24px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .username {
      color: #666;
      font-weight: 600;
    }

    .logout-btn {
      padding: 10px 20px;
      background: #e0e0e0;
      color: #333;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .logout-btn:hover {
      background: #d0d0d0;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .card-item {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: all 0.3s;
    }

    .card-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .card-item img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .card-info {
      padding: 15px;
    }

    .card-id {
      color: #667eea;
      font-weight: 700;
      font-size: 14px;
      font-style: italic;
      margin-bottom: 5px;
    }

    .card-name {
      color: #333;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .status-free {
      color: #28a745;
      font-weight: 600;
    }

    .status-mine {
      color: #667eea;
      font-weight: 600;
    }

    .status-taken {
      color: #999;
      font-style: italic;
    }

    .card-item.taken {
      cursor: pointer;
      opacity: 0.7;
    }

    /* Editor Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }

    .modal.active {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 40px;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      max-width: 800px;
      width: 100%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      margin-bottom: 40px;
    }

    .modal-header {
      padding: 25px 30px;
      border-bottom: 2px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      color: #333;
      font-size: 22px;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      color: #999;
      cursor: pointer;
      line-height: 1;
      transition: color 0.3s;
    }

    .close-btn:hover {
      color: #333;
    }

    .modal-body {
      padding: 30px;
    }

    .image-preview {
      margin-bottom: 30px;
      border-radius: 8px;
      overflow: hidden;
      background: #f5f5f5;
    }

    .image-preview img {
      width: 100%;
      height: auto;
      display: block;
    }

    .editor-form label {
      display: block;
      color: #333;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .editor-form input[type="text"],
    .editor-form textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-family: inherit;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .editor-form input[type="text"]:focus,
    .editor-form textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .editor-form textarea {
      resize: vertical;
      min-height: 100px;
    }

    #scientificName {
      font-style: italic;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .modal-footer {
      padding: 20px 30px;
      border-top: 2px solid #f0f0f0;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .btn-cancel {
      padding: 12px 24px;
      background: #e0e0e0;
      color: #333;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-cancel:hover {
      background: #d0d0d0;
    }

    .btn-save {
      padding: 12px 24px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-save:hover:not(:disabled) {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-save:disabled {
      background: #b0bec5;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .btn-unadopt {
      padding: 12px 24px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-unadopt:hover {
      background: #c82333;
    }

    .save-indicator {
      margin-top: 15px;
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      display: none;
      font-size: 13px;
      font-weight: 600;
    }

    .save-indicator.success {
      display: block;
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    @media (max-width: 768px) {
      .cards-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .modal-footer {
        flex-direction: column;
      }

      .btn-cancel,
      .btn-save,
      .btn-unadopt {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-container" id="loginScreen">
    <div class="login-box">
      <h1>Editor de Fitxes</h1>
      <div class="info-box">
        A continuació veuràs 15 fotografies, algunes tenen el nom de l'usuari que ha "adoptat" l'espècie, d'altres estàn lliures. Si fas clic en una d'aquestes últimes podràs adoptar l'espècie simplement escrivint el nom comú i el comentari i fent clic al botó "Adoptar". Recorda que pots trobar aquesta informació a https://www.cibsub.cat/ i a la Viquipèdia</div>
      <div class="error-message" id="loginError">Usuari o contrasenya incorrectes</div>
      <form id="loginForm">
        <div class="form-group">
          <label for="username">Usuari</label>
          <input type="text" id="username" name="username" required autofocus>
        </div>
        <div class="form-group">
          <label for="password">Contrasenya</label>
          <input type="password" id="password" name="password" required>
        </div>
        <button type="submit" class="login-btn">Iniciar sessió</button>
      </form>
    </div>
  </div>

  <!-- Main App -->
  <div class="app-container" id="appContainer">
    <div class="app-header">
      <h1>Editor de Fitxes - FotosCavet</h1>
      <div class="user-info">
        <span class="username" id="currentUser"></span>
        <button class="logout-btn" id="logoutBtn">Tancar sessió</button>
      </div>
    </div>

    <div class="cards-grid" id="cardsGrid">
      <!-- Cards will be loaded here -->
    </div>
  </div>

  <!-- Editor Modal -->
  <div class="modal" id="editorModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Editar Fitxa</h2>
        <button class="close-btn" id="closeModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="image-preview">
          <img id="modalImage" src="" alt="">
        </div>

        <form class="editor-form" id="editorForm">
          <div class="form-row">
            <div class="form-group">
              <label for="commonName">Nom comú</label>
              <input type="text" id="commonName" name="commonName" placeholder="Ex: Ocelot">
            </div>
            <div class="form-group">
              <label for="scientificName">Nom científic</label>
              <input type="text" id="scientificName" name="scientificName" placeholder="Ex: Leopardus pardalis" readonly>
            </div>
          </div>

          <div class="form-group">
            <label for="comment">Comentari</label>
            <textarea id="comment" name="comment" placeholder="Afegeix comentaris sobre la imatge..."></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="fotoAuthor">Autor de la foto</label>
              <input type="text" id="fotoAuthor" name="fotoAuthor" readonly placeholder="Autor de la imatge">
            </div>
            <div class="form-group">
              <label for="cardAuthor">Autor de la fitxa</label>
              <input type="text" id="cardAuthor" name="cardAuthor" readonly>
            </div>
          </div>

          <div class="save-indicator success" id="saveIndicator" style="display: none;">
            ✓ Fitxa guardada correctament
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn-unadopt" id="unadoptBtn" style="display: none; margin-right: auto;">Alliberar fitxa</button>
        <button class="btn-cancel" id="cancelBtn">Cancel·lar</button>
        <button class="btn-save" id="saveBtn">Guardar canvis</button>
      </div>
    </div>
  </div>

  <script>
    // Google Apps Script URL
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyge7qifH1P3rka7vwgNf5Q96gRQRS92vbvlBUJkscnBkto1_zAcNp4GaufGrfy4OGaSg/exec';

    let currentUser = null;
    let currentUserData = null;
    let currentEditingCard = null;
    let imagesData = [];
    let allCards = []; // Loaded from Cards sheet (replaces hardcoded CARD_MAPPINGS)

    // Elements
    const loginScreen = document.getElementById('loginScreen');
    const appContainer = document.getElementById('appContainer');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    const currentUserSpan = document.getElementById('currentUser');
    const logoutBtn = document.getElementById('logoutBtn');
    const cardsGrid = document.getElementById('cardsGrid');
    const editorModal = document.getElementById('editorModal');
    const closeModal = document.getElementById('closeModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveBtn = document.getElementById('saveBtn');
    const unadoptBtn = document.getElementById('unadoptBtn');
    const editorForm = document.getElementById('editorForm');

    // Login handler
    loginForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const loginBtn = document.querySelector('.login-btn');

      loginBtn.disabled = true;
      loginBtn.textContent = 'Iniciant sessió...';

      try {
        const url = `${APPS_SCRIPT_URL}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`;
        const response = await fetch(url);
        const result = await response.json();

        if (result.status === 'success') {
          currentUser = result.user.username;
          currentUserData = result.user;
          sessionStorage.setItem('currentUser', result.user.username);
          sessionStorage.setItem('userData', JSON.stringify(result.user));
          showApp();
        } else {
          loginError.textContent = result.message || 'Usuari o contrasenya incorrectes';
          loginError.classList.add('show');
          setTimeout(() => loginError.classList.remove('show'), 3000);
        }
      } catch (error) {
        console.error('Login error:', error);
        loginError.textContent = 'Error de connexió. Intenta-ho de nou.';
        loginError.classList.add('show');
        setTimeout(() => loginError.classList.remove('show'), 3000);
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Iniciar sessió';
      }
    });

    // Logout handler
    logoutBtn.addEventListener('click', function() {
      currentUser = null;
      currentUserData = null;
      sessionStorage.removeItem('currentUser');
      sessionStorage.removeItem('userData');
      loginScreen.style.display = 'flex';
      appContainer.classList.remove('active');
      loginForm.reset();
    });

    // Show app
    function showApp() {
      loginScreen.style.display = 'none';
      appContainer.classList.add('active');
      currentUserSpan.textContent = currentUserData?.displayName || currentUser;
      loadCards();
    }

    // Load cards from Google Sheets
    async function loadCards() {
      try {
        const [imagesResponse, cardsResponse] = await Promise.all([
          fetch('images.json'),
          fetch(`${APPS_SCRIPT_URL}?action=getCards`)
        ]);
        imagesData = await imagesResponse.json();
        const cardsResult = await cardsResponse.json();
        if (cardsResult.status === 'success') {
          allCards = cardsResult.cards;
        }
        renderCards();
      } catch (err) {
        console.error('Error loading data:', err);
      }
    }

    // Render cards with adoption status
    function renderCards() {
      cardsGrid.innerHTML = '';

      allCards.forEach(card => {
        const imageData = imagesData.find(img => img.id === card.photoId);
        if (!imageData) return;

        const cardElement = document.createElement('div');
        cardElement.className = 'card-item';

        const currentDisplayName = currentUserData?.displayName || currentUser;
        const isAdoptedByMe = card.cardAuthor === currentDisplayName;
        const isFree = !card.cardAuthor;

        let statusText = '';
        let statusClass = '';

        if (isFree) {
          statusText = 'Lliure - Fes clic per adoptar';
          statusClass = 'status-free';
          cardElement.onclick = () => openEditor(card);
        } else if (isAdoptedByMe) {
          statusText = 'La teva fitxa';
          statusClass = 'status-mine';
          cardElement.onclick = () => openEditor(card);
        } else {
          statusText = 'Adoptada per ' + card.cardAuthor;
          statusClass = 'status-taken';
          cardElement.classList.add('taken');
          cardElement.onclick = () => openEditor(card);
        }

        const scientificName = card.scientificName || 'Nom pendent';

        cardElement.innerHTML = `
          <img src="${imageData.url}" alt="${imageData.titulo}" loading="lazy">
          <div class="card-info">
            <div class="card-id">${scientificName}</div>
            <div class="card-name ${statusClass}">${statusText}</div>
          </div>
        `;

        cardsGrid.appendChild(cardElement);
      });
    }

    // Open editor
    function openEditor(card) {
      currentEditingCard = card;
      const imageData = imagesData.find(img => img.id === card.photoId);
      const currentDisplayName = currentUserData?.displayName || currentUser;
      const isFree = !card.cardAuthor;
      const isMyCard = card.cardAuthor === currentDisplayName;
      const isViewOnly = !isFree && !isMyCard;

      // Title
      if (isViewOnly) {
        document.getElementById('modalTitle').textContent = `Fitxa ${card.cardId}`;
      } else if (isFree) {
        document.getElementById('modalTitle').textContent = `Adoptar fitxa ${card.cardId}`;
      } else {
        document.getElementById('modalTitle').textContent = `Editar fitxa ${card.cardId}`;
      }

      document.getElementById('modalImage').src = imageData ? imageData.url : '';

      // Populate form from card data
      document.getElementById('commonName').value = card.commonName || '';
      document.getElementById('scientificName').value = card.scientificName || '';
      document.getElementById('comment').value = card.comment || '';
      document.getElementById('fotoAuthor').value = card.fotoAuthor || '';
      document.getElementById('cardAuthor').value = card.cardAuthor || currentDisplayName;

      // Field editability
      document.getElementById('commonName').readOnly = isViewOnly;
      document.getElementById('comment').readOnly = isViewOnly;

      // Buttons
      if (isViewOnly) {
        saveBtn.style.display = 'none';
        unadoptBtn.style.display = 'none';
        cancelBtn.textContent = 'Tancar';
      } else {
        saveBtn.style.display = 'inline-block';
        saveBtn.textContent = isFree ? 'Adoptar fitxa' : 'Guardar canvis';
        unadoptBtn.style.display = isFree ? 'none' : 'inline-block';
        cancelBtn.textContent = 'Cancel·lar';
      }

      editorModal.classList.add('active');
      if (!isViewOnly) validateForm();
    }

    // Close editor
    function closeEditor() {
      editorModal.classList.remove('active');
      currentEditingCard = null;
      editorForm.reset();
      // Reset field editability
      document.getElementById('commonName').readOnly = false;
      document.getElementById('comment').readOnly = false;
      saveBtn.style.display = 'inline-block';
      cancelBtn.textContent = 'Cancel·lar';
    }

    // Form validation: require commonName and comment
    function validateForm() {
      const name = document.getElementById('commonName').value.trim();
      const comment = document.getElementById('comment').value.trim();
      saveBtn.disabled = !name || !comment;
    }

    document.getElementById('commonName').addEventListener('input', validateForm);
    document.getElementById('comment').addEventListener('input', validateForm);

    closeModal.addEventListener('click', closeEditor);
    cancelBtn.addEventListener('click', closeEditor);

    // Close modal when clicking outside
    editorModal.addEventListener('click', function(e) {
      if (e.target === editorModal) {
        closeEditor();
      }
    });

    // Save card data to Google Sheets
    saveBtn.addEventListener('click', async function() {
      if (!currentEditingCard) return;

      saveBtn.disabled = true;
      saveBtn.textContent = 'Guardant...';

      const data = {
        cardId: currentEditingCard.cardId,
        commonName: document.getElementById('commonName').value,
        scientificName: document.getElementById('scientificName').value,
        comment: document.getElementById('comment').value,
        fotoAuthor: document.getElementById('fotoAuthor').value,
        cardAuthor: currentUserData?.displayName || currentUser,
        username: currentUser
      };

      try {
        const params = Object.entries(data)
          .map(([k, v]) => `${k}=${encodeURIComponent(v)}`)
          .join('&');
        const url = `${APPS_SCRIPT_URL}?action=saveCard&${params}`;
        const response = await fetch(url);
        const result = await response.json();

        if (result.status === 'success') {
          // Update local cache
          const cardIndex = allCards.findIndex(c => c.cardId === data.cardId);
          if (cardIndex !== -1) {
            allCards[cardIndex] = { ...allCards[cardIndex], ...data };
            currentEditingCard = allCards[cardIndex];
          }

          // If this was an adoption, update user data
          if (result.adopted) {
            currentUserData.adoptedCard = data.cardId;
            sessionStorage.setItem('userData', JSON.stringify(currentUserData));
          }

          const indicator = document.getElementById('saveIndicator');
          indicator.textContent = result.adopted
            ? 'Fitxa adoptada correctament!'
            : 'Fitxa guardada correctament';
          indicator.style.display = 'block';
          setTimeout(() => {
            indicator.style.display = 'none';
            renderCards();
            closeEditor();
          }, 1500);
        } else {
          alert('Error: ' + (result.message || 'Error desconegut'));
        }
      } catch (error) {
        console.error('Error saving card:', error);
        alert('Error de connexió. Intenta-ho de nou.');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = currentEditingCard?.cardAuthor ? 'Guardar canvis' : 'Adoptar fitxa';
      }
    });

    // Unadopt card handler
    unadoptBtn.addEventListener('click', async function() {
      if (!currentEditingCard) return;

      if (!confirm('Segur que vols alliberar aquesta fitxa? Es perdran les dades introduïdes.')) return;

      unadoptBtn.disabled = true;
      unadoptBtn.textContent = 'Alliberant...';

      try {
        const url = `${APPS_SCRIPT_URL}?action=unadoptCard&cardId=${encodeURIComponent(currentEditingCard.cardId)}&username=${encodeURIComponent(currentUser)}`;
        const response = await fetch(url);
        const result = await response.json();

        if (result.status === 'success') {
          // Update local cache
          const cardIndex = allCards.findIndex(c => c.cardId === currentEditingCard.cardId);
          if (cardIndex !== -1) {
            allCards[cardIndex].cardAuthor = '';
            allCards[cardIndex].commonName = '';
            allCards[cardIndex].comment = '';
          }

          currentUserData.adoptedCard = '';
          sessionStorage.setItem('userData', JSON.stringify(currentUserData));

          renderCards();
          closeEditor();
        } else {
          alert('Error: ' + (result.message || 'Error desconegut'));
        }
      } catch (error) {
        console.error('Error unadopting card:', error);
        alert('Error de connexió. Intenta-ho de nou.');
      } finally {
        unadoptBtn.disabled = false;
        unadoptBtn.textContent = 'Alliberar fitxa';
      }
    });

    // Check if user is already logged in
    const savedUser = sessionStorage.getItem('currentUser');
    const savedUserData = sessionStorage.getItem('userData');
    if (savedUser && savedUserData) {
      currentUser = savedUser;
      currentUserData = JSON.parse(savedUserData);
      showApp();
    }
  </script>
</body>
</html>
